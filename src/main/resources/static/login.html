<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Iniciar sesión — Stark Industries</title>
    <link rel="stylesheet" href="css/login.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
</head>
<body>
<main class="auth">
    <section class="card" role="form" aria-labelledby="login-title">
        <header class="card__header">
            <h1 id="login-logo">STARK <span>INDUSTRIES</span></h1>
            <h1 id="login-title">Iniciar sesión en el Panel de Sensores</h1>
            <p class="subtitle">Accede con tus credenciales corporativas</p>
        </header>

        <!-- Mensajes dinámicos -->
        <div id="msg" class="msg" role="status" aria-live="polite"></div>

        <form id="loginForm" action="/auth/login" method="post" novalidate>
            <!-- CSRF (si tu backend lo usa) -->
            <input type="hidden" name="_csrf" id="csrfField">

            <div class="field">
                <label for="username">Usuario</label>
                <input
                        id="username"
                        name="username"
                        type="text"
                        placeholder="tu.usuario"
                        inputmode="text"
                        autocomplete="username"
                        required
                />
            </div>

            <div class="field">
                <label for="password">Contraseña</label>
                <div class="password-wrap">
                    <input
                            id="password"
                            name="password"
                            type="password"
                            placeholder="••••••••"
                            autocomplete="current-password"
                            required
                            minlength="6"
                    />
                    <button type="button" class="toggle" aria-label="Mostrar u ocultar contraseña">
                        👁️
                    </button>
                </div>
            </div>

            <div class="row">
                <label class="checkbox">
                    <input type="checkbox" name="remember" value="true" />
                    <span>Recordarme</span>
                </label>
                <a class="link" href="/auth/forgot">¿Olvidaste tu contraseña?</a>
            </div>

            <button id="loginBtn" type="button" class="btn btn--primary">Entrar</button>

            <!-- 🆕 Enlace de registro -->
            <p class="muted" style="margin-top:10px">
                ¿No tienes cuenta? <a class="link" href="register.html">Regístrate aquí</a>
            </p>
        </form>

        <footer class="card__footer">
            <p class="muted">
                © <span id="year"></span> Stark Industries · Seguridad de acceso habilitada
            </p>
        </footer>
    </section>
</main>

<script>
    (function(){
        console.log("HOLAHOLA");
      const form = document.getElementById('loginForm');
      const btn  = document.getElementById('loginBtn');
      const msg  = document.getElementById('msg');
      const user = document.getElementById('username');
      const pass = document.getElementById('password');

      btn.addEventListener('click', async () => {
        const username = user.value.trim();
        const password = pass.value; // variable JS en memoria

        if (!username || !password) {
          msg.textContent = 'Introduce usuario y contraseña';
          msg.classList.add('msg--error');
          return;
        }

        // Guardamos variables de los campos
        sessionStorage.setItem('si.username', username);
        // ⚠️ No guardamos password en almacenamiento persistente por seguridad

        // Llamada GET a /auth/login devolviendo 0 o -1
        const url = `/auth/login?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;

        try {
          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          // El backend devuelve un número JSON (0 o -1). P.ej. 0
          const code = await res.json();

          if (code === 0) {
            msg.textContent = '✅ Acceso concedido, entrando...';
            msg.classList.remove('msg--error');
            msg.classList.add('msg--ok');
            setTimeout(() => { window.location.href = '/index.html'; }, 300);
          } else {
            msg.textContent = '❌ Usuario o contraseña incorrectos';
            msg.classList.remove('msg--ok');
            msg.classList.add('msg--error');
            pass.value = '';
            pass.focus();
          }
        } catch (e) {
          console.error(e);
          msg.textContent = 'Error de red. Inténtalo de nuevo.';
          msg.classList.remove('msg--ok');
          msg.classList.add('msg--error');
        }
      });
    })();
</script>

</body>
</html>
